# üéØ CONTEXTO COMPLETO DO PROJETO - CHECKPOINT v1.1.0

**Calculadora Trabalhista Web - Sistema de c√°lculos jur√≠dicos com SELIC din√¢mica**

**Data:** 2025-10-01  
**Vers√£o Atual:** v1.1.0 ‚úÖ FUNCIONAL  
**Pr√≥xima Vers√£o:** v1.2.0 (Multi-munic√≠pio)

---

## üìä ESTADO ATUAL (v1.1.0)

### ‚úÖ O que est√° FUNCIONANDO (100%)

1. **Munic√≠pio TIMON**
   - ‚úÖ 9 cen√°rios de c√°lculo completos
   - ‚úÖ Valores principais calculados pelo Excel
   - ‚úÖ Honor√°rios calculados em Python (din√¢mico, configur√°vel)
   - ‚úÖ Des√°gio funcional (Principal e Honor√°rios)
   - ‚úÖ Export CSV completo com metadados
   - ‚úÖ 16 testes automatizados (100% passando)
   - ‚úÖ Validado contra planilha (0.0000% diferen√ßa)

2. **Arquitetura H√≠brida**
   - ‚úÖ **Excel:** C√°lculos complexos (SELIC, IPCA, TR, corre√ß√£o monet√°ria)
   - ‚úÖ **Python:** Honor√°rios, totais, des√°gio (HonorariosCalculator)
   - ‚úÖ **Frontend:** Interface web moderna e responsiva
   - ‚úÖ **API REST:** FastAPI com valida√ß√µes Pydantic

3. **Integra√ß√£o Excel**
   - ‚úÖ L√™ arquivo local: `data/timon_01-2025.xlsx`
   - ‚úÖ Escreve inputs do usu√°rio em c√©lulas espec√≠ficas (RESUMO!B6-B15)
   - ‚úÖ L√™ outputs calculados (RESUMO!D24:F69)
   - ‚úÖ Usa c√≥pia tempor√°ria (n√£o modifica original)
   - ‚úÖ Tempo de execu√ß√£o: ~2-3 minutos por c√°lculo

4. **Testes Completos**
   - ‚úÖ 10 testes unit√°rios (HonorariosCalculator)
   - ‚úÖ 6 testes de integra√ß√£o (Excel vs Site)
   - ‚úÖ Valida√ß√£o de precis√£o (diferen√ßa < 0.01%)
   - ‚úÖ 100% passando

---

## ‚ö†Ô∏è LIMITA√á√ÉO CR√çTICA - PR√ìXIMA SESS√ÉO

### üö® **APENAS TIMON EST√Å DISPON√çVEL**

**Motivo:** A planilha Excel (`timon_01-2025.xlsx`) cont√©m apenas dados internos de TIMON.

**O Problema:**
```
Usu√°rio tenta calcular "S√ÉO LU√çS"
‚Üí Site escreve "S√ÉO LU√çS" em Excel!B6
‚Üí Excel busca dados de "S√ÉO LU√çS" nas tabelas internas
‚Üí N√ÉO ENCONTRA (s√≥ tem TIMON)
‚Üí Retorna R$ 0,00 para todos os cen√°rios
```

**Por que acontece:**
- üìä A planilha **J√Å ERA USADA** na empresa (n√£o √© nova)
- üìä Cont√©m **dados internos** espec√≠ficos de cada munic√≠pio
- üìä Esses dados **N√ÉO s√£o p√∫blicos** (tabelas, hist√≥ricos, par√¢metros locais)
- üìä Empresa tem **planilhas separadas** para cada munic√≠pio
- üìä Voc√™ s√≥ tem acesso √† de **TIMON** no momento

**Decis√£o Tomada:**
‚ùå **N√ÉO perguntar √† empresa** (dados podem estar no Excel)  
‚úÖ **DISSECAR o Excel** automaticamente (script Python)  
‚úÖ **Descobrir munic√≠pios** sem hardcode  
‚úÖ **Extrair estrutura** de dados automaticamente

---

## üéØ TAREFA PRIORIT√ÅRIA - PR√ìXIMA SESS√ÉO

### **DISSECAR O EXCEL AUTOMATICAMENTE PARA DESCOBRIR MUNIC√çPIOS**

**Objetivo:** Extrair TODOS os dados do Excel sem hardcode, sem perguntar nada

**Abordagem:** Script Python que analisa a planilha e descobre:
- ‚úÖ Quais munic√≠pios existem (em valida√ß√µes, tabelas, f√≥rmulas)
- ‚úÖ Estrutura de dados e tabelas internas
- ‚úÖ C√©lulas de input/output
- ‚úÖ Ranges nomeados (named ranges)
- ‚úÖ F√≥rmulas que referenciam munic√≠pio (B6)
- ‚úÖ Abas ocultas ou secund√°rias
- ‚úÖ Padr√µes de PROCV/SE que buscam por munic√≠pio

---

## üõ†Ô∏è SCRIPTS PRONTOS PARA AN√ÅLISE (N√ÉO EXECUTADOS AINDA)

### **Script 1: `scripts/analyze_excel.py`** (PRONTO PARA USAR)

**O que faz:**
- üîç Analisa estrutura completa da planilha `timon_01-2025.xlsx`
- üìä Detecta munic√≠pios em valida√ß√µes, tabelas, f√≥rmulas
- üìë Lista todas as abas (vis√≠veis e ocultas)
- üè∑Ô∏è Identifica ranges nomeados
- üì• Mapeia c√©lulas de input (B6, B11, etc.)
- üì§ Mapeia c√©lulas de output (D24:F69)
- üíæ Gera `analysis_result.json` com TUDO descoberto

**Como executar (quando quiser):**
```bash
python scripts/analyze_excel.py
cat analysis_result.json
```

**C√≥digo completo:** Veja se√ß√£o "C√ìDIGO DOS SCRIPTS" no final deste documento.

---

### **Script 2: `scripts/create_municipality_support.py`** (PRONTO PARA USAR)

**O que faz:**
- üìÑ L√™ `analysis_result.json` (gerado pelo Script 1)
- üèóÔ∏è Gera `src/municipality_mapper.py` automaticamente
- üîß Cria c√≥digo de mapeamento din√¢mico (sem hardcode)
- ‚úÖ Detecta munic√≠pios pelos arquivos .xlsx na pasta `data/`

**Como executar (depois do Script 1):**
```bash
python scripts/create_municipality_support.py
```

---

## üìã PLANO DE EXECU√á√ÉO (v1.2.0)

### **Fase 1: AN√ÅLISE**
```bash
python scripts/analyze_excel.py
code analysis_result.json
```

### **Fase 2: GERA√á√ÉO**
```bash
python scripts/create_municipality_support.py
code src/municipality_mapper.py
```

### **Fase 3: INTEGRA√á√ÉO**
```python
# calculator_service.py
from municipality_mapper import MunicipalityMapper

mapper = MunicipalityMapper()
excel_path = mapper.get_path(municipio)
```

### **Fase 4: TESTES**
```bash
pytest tests/test_integration_*.py -v
```

---

## üöÄ ROADMAP

### v1.1.0 ‚úÖ **CONCLU√çDA**
- ‚úÖ TIMON funcionando 100%
- ‚úÖ Honor√°rios em Python
- ‚úÖ 16 testes passando
- ‚úÖ Valida√ß√£o vs Excel (0.0000%)

### v1.2.0 üéØ **PR√ìXIMA**
- [ ] Executar `analyze_excel.py`
- [ ] Gerar mapeamento autom√°tico
- [ ] Integrar MunicipalityMapper
- [ ] Dropdown din√¢mico com munic√≠pios
- [ ] Valida√ß√£o de munic√≠pio
- [ ] Testes para cada munic√≠pio

### v1.3.0 üîÆ **FUTURO**
- [ ] Cache de resultados
- [ ] API BACEN (SELIC din√¢mica)
- [ ] Hist√≥rico de c√°lculos

### v2.0.0 üöÄ **VIS√ÉO**
- [ ] C√°lculos 100% Python
- [ ] Performance <5s
- [ ] Multi-usu√°rio

---

## üí° DECIS√ïES IMPORTANTES

### **1. N√ÉO fazer hardcode**
‚ùå `MUNICIPIOS = ["TIMON", "S√ÉO LU√çS"]`  
‚úÖ `glob("data/*_01-2025.xlsx")` (autom√°tico)

### **2. N√ÉO perguntar √† empresa**
‚ùå Depender de informa√ß√£o externa  
‚úÖ Analisar Excel automaticamente

### **3. Manter Excel na v1.2.0**
‚úÖ F√≥rmulas validadas  
‚úÖ Funciona 100%  
‚úÖ Adicionar munic√≠pios = ~4h  
‚è±Ô∏è Migrar para Python = semanas

---

## üìä ESTRUTURA ATUAL

```
selicmvpfinal/
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ timon_01-2025.xlsx          ‚úÖ √önica planilha
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ calculator_service.py       ‚úÖ Orquestra c√°lculos
‚îÇ   ‚îú‚îÄ‚îÄ honorarios_calculator.py    ‚úÖ Honor√°rios Python
‚îÇ   ‚îú‚îÄ‚îÄ excel_template_calculator.py ‚úÖ L√™/escreve Excel
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ static/                         ‚úÖ Frontend
‚îú‚îÄ‚îÄ tests/                          ‚úÖ 16 testes (100%)
‚îú‚îÄ‚îÄ scripts/  (CRIAR PR√ìXIMA SESS√ÉO)
‚îÇ   ‚îú‚îÄ‚îÄ analyze_excel.py            üîß Analisar Excel
‚îÇ   ‚îî‚îÄ‚îÄ create_municipality_support.py üîß Gerar c√≥digo
‚îî‚îÄ‚îÄ docs/                           ‚úÖ Documenta√ß√£o
```

---

## üîß C√ìDIGO DOS SCRIPTS (COPIAR QUANDO FOR USAR)

### **`scripts/analyze_excel.py`**

```python
"""
An√°lise Completa da Planilha Excel
Descobre munic√≠pios, tabelas, f√≥rmulas automaticamente
SEM HARDCODE, SEM PERGUNTAR NADA
"""
import openpyxl
from openpyxl.utils import get_column_letter
from pathlib import Path
import json


class ExcelAnalyzer:
    def __init__(self, excel_path: str):
        self.excel_path = Path(excel_path)
        self.wb = openpyxl.load_workbook(excel_path, data_only=False, keep_vba=True)
        self.analysis = {
            "municipios_encontrados": set(),
            "abas": {},
            "tabelas_nomeadas": {},
            "validacoes": {},
            "formulas_importantes": {},
        }
    
    def analyze_all(self):
        print("üîç Iniciando an√°lise...")
        self.analyze_sheets()
        self.analyze_named_ranges()
        self.analyze_data_validations()
        self.analyze_formulas()
        self.find_municipalities()
        self.print_report()
        self.save_json()
    
    def analyze_sheets(self):
        print("üìë Analisando abas...")
        for sheet_name in self.wb.sheetnames:
            ws = self.wb[sheet_name]
            count_val = count_formula = 0
            
            for row in ws.iter_rows():
                for cell in row:
                    if cell.value:
                        count_val += 1
                        if isinstance(cell.value, str) and cell.value.startswith('='):
                            count_formula += 1
            
            self.analysis["abas"][sheet_name] = {
                "visivel": ws.sheet_state == 'visible',
                "valores": count_val,
                "formulas": count_formula
            }
        print(f"   ‚úÖ {len(self.analysis['abas'])} abas\n")
    
    def analyze_named_ranges(self):
        print("üè∑Ô∏è  Ranges nomeados...")
        for name in self.wb.defined_names.definedName:
            try:
                self.analysis["tabelas_nomeadas"][name.name] = str(name.value)
            except:
                pass
        print(f"   ‚úÖ {len(self.analysis['tabelas_nomeadas'])} ranges\n")
    
    def analyze_data_validations(self):
        print("‚úÖ Valida√ß√µes (dropdowns)...")
        for sheet_name in self.wb.sheetnames:
            ws = self.wb[sheet_name]
            if hasattr(ws, 'data_validations'):
                for dv in ws.data_validations.dataValidation:
                    if dv.type == "list":
                        formula = dv.formula1
                        valores = formula.strip('"').split(',') if formula.startswith('"') else [f"Ref: {formula}"]
                        self.analysis["validacoes"][f"{sheet_name}!{dv.sqref}"] = valores
        print(f"   ‚úÖ {len(self.analysis['validacoes'])} valida√ß√µes\n")
    
    def analyze_formulas(self):
        print("üî¢ F√≥rmulas importantes...")
        if "RESUMO" in self.wb.sheetnames:
            ws = self.wb["RESUMO"]
            for row_idx in range(24, 70):
                for col_idx in range(4, 7):
                    cell = ws.cell(row_idx, col_idx)
                    if cell.value and isinstance(cell.value, str) and cell.value.startswith('='):
                        coord = f"{get_column_letter(col_idx)}{row_idx}"
                        self.analysis["formulas_importantes"][coord] = {
                            "ref_b6": "$B$6" in cell.value or "B6" in cell.value,
                            "procv": "PROCV" in cell.value.upper() or "VLOOKUP" in cell.value.upper(),
                        }
        print(f"   ‚úÖ {len(self.analysis['formulas_importantes'])} f√≥rmulas\n")
    
    def find_municipalities(self):
        print("üèôÔ∏è  Procurando munic√≠pios...")
        
        # Valida√ß√µes
        for key, vals in self.analysis["validacoes"].items():
            if "B6" in key or "municip" in key.lower():
                for v in vals:
                    if v and not v.startswith("Ref"):
                        self.analysis["municipios_encontrados"].add(v.strip().upper())
        
        # Padr√µes comuns
        comuns = ["TIMON", "S√ÉO LU√çS", "IMPERATRIZ", "CAXIAS"]
        for sheet_name in self.wb.sheetnames:
            ws = self.wb[sheet_name]
            for row in ws.iter_rows(max_row=50):
                for cell in row:
                    if cell.value and isinstance(cell.value, str):
                        for mun in comuns:
                            if mun in cell.value.upper():
                                self.analysis["municipios_encontrados"].add(mun)
        
        print(f"   ‚úÖ {len(self.analysis['municipios_encontrados'])} munic√≠pios\n")
    
    def print_report(self):
        print("\n" + "="*80)
        print("üìä RELAT√ìRIO")
        print("="*80 + "\n")
        
        print("üèôÔ∏è  MUNIC√çPIOS:")
        for m in sorted(self.analysis["municipios_encontrados"]):
            print(f"   ‚úÖ {m}")
        print()
        
        print("‚úÖ VALIDA√á√ïES:")
        for cel, vals in self.analysis["validacoes"].items():
            print(f"   üìç {cel}: {', '.join(vals[:3])}")
        print()
    
    def save_json(self):
        analysis_copy = dict(self.analysis)
        analysis_copy["municipios_encontrados"] = list(analysis_copy["municipios_encontrados"])
        
        with open("analysis_result.json", 'w', encoding='utf-8') as f:
            json.dump(analysis_copy, f, indent=2, ensure_ascii=False)
        
        print(f"üíæ Salvo em: analysis_result.json\n")


def main():
    excel_path = Path("data/timon_01-2025.xlsx")
    if not excel_path.exists():
        print(f"‚ùå N√£o encontrado: {excel_path}")
        return
    
    analyzer = ExcelAnalyzer(str(excel_path))
    analyzer.analyze_all()
    print("="*80)
    print("‚úÖ CONCLU√çDO!")
    print("="*80)


if __name__ == "__main__":
    main()
```

---

### **`scripts/create_municipality_support.py`**

```python
"""
Gera c√≥digo autom√°tico de suporte multi-munic√≠pio
"""
import json
from pathlib import Path


def main():
    print("üîß Gerando suporte...\n")
    
    try:
        with open("analysis_result.json", 'r', encoding='utf-8') as f:
            analysis = json.load(f)
    except FileNotFoundError:
        print("‚ùå Execute primeiro: python scripts/analyze_excel.py")
        return
    
    municipios = analysis.get("municipios_encontrados", [])
    
    print(f"‚úÖ {len(municipios)} munic√≠pios:")
    for m in municipios:
        print(f"   üìç {m}")
    
    code = f'''"""
Mapeamento Din√¢mico - Gerado automaticamente
"""
from pathlib import Path
from typing import Optional, List


class MunicipalityMapper:
    def __init__(self, data_dir: str = "data"):
        self.data_dir = Path(data_dir)
        self.municipios = self._discover()
    
    def _discover(self):
        found = {{}}
        for f in self.data_dir.glob("*_01-2025.xlsx"):
            mun = f.stem.split("_")[0].upper()
            found[mun] = str(f)
        return found
    
    def get_path(self, municipio: str) -> Optional[str]:
        return self.municipios.get(municipio.upper().strip())
    
    def list_all(self) -> List[str]:
        return sorted(self.municipios.keys())
    
    def validate(self, municipio: str) -> bool:
        return municipio.upper().strip() in self.municipios


# Encontrados: {municipios}
'''
    
    Path("src/municipality_mapper.py").write_text(code, encoding='utf-8')
    print(f"\n‚úÖ Gerado: src/municipality_mapper.py")


if __name__ == "__main__":
    main()
```

---

## üìû QUANDO COME√áAR PR√ìXIMA SESS√ÉO

1. ‚úÖ **Ler este arquivo** (`.LEIA-ME.md`)
2. üîç **Criar pasta scripts/**
3. üìÑ **Copiar os 2 scripts**
4. ‚ñ∂Ô∏è **Executar**: `python scripts/analyze_excel.py`
5. üìä **Revisar**: `analysis_result.json`
6. üèóÔ∏è **Executar**: `python scripts/create_municipality_support.py`
7. üîß **Integrar** MunicipalityMapper
8. üß™ **Testar** novos munic√≠pios

---

**Status:** v1.1.0 EST√ÅVEL | Scripts prontos | Aguardando execu√ß√£o  
**√öltima atualiza√ß√£o:** 2025-10-01  
**Pr√≥xima a√ß√£o:** Executar `analyze_excel.py` üîç
