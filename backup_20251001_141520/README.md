# üßÆ Calculadora Trabalhista - MVP# üéØ PROMPT MESTRE - MVP WEB CALCULADORA TRABALHISTA



> Aplica√ß√£o web que calcula valores trabalhistas usando planilha Excel local como motor de c√°lculo.**Vers√£o:** 2.0  

**Data:** 01/10/2025  

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/)**Objetivo:** Criar aplica√ß√£o web que usa planilha Excel como motor de c√°lculo com SELIC din√¢mica

[![FastAPI](https://img.shields.io/badge/FastAPI-0.109.0-green.svg)](https://fastapi.tiangolo.com/)

[![Status](https://img.shields.io/badge/Status-MVP%20Ready-success.svg)]()---



---## üìã VIS√ÉO GERAL



## üöÄ In√≠cio R√°pidoAplica√ß√£o web **SEM LOGIN** que:

1. Recebe inputs do usu√°rio via formul√°rio

### Windows (PowerShell)2. Escreve nas c√©lulas mapeadas da planilha Excel

```powershell3. Atualiza dados de SELIC via API Banco Central (opcional)

.\scripts\start.bat4. Executa c√°lculos no Excel (via Microsoft Graph API)

```5. L√™ outputs calculados

6. Exibe resultados na tela

Acesse: **http://localhost:8000**7. Permite exportar CSV



---**Princ√≠pio fundamental:** N√ÉO reimplementar regras de neg√≥cio. A planilha Excel √© o backend de c√°lculo.



## üìã Pr√©-requisitos---



- Python 3.8 ou superior## üèóÔ∏è ARQUITETURA

- Arquivo Excel na pasta `data/`

- 2 minutos de tempo### Stack Recomendado

- **Backend:** Python (FastAPI) ou Node.js (Express)

---- **Frontend:** HTML/CSS/JS simples ou React

- **Armazenamento:** OneDrive/SharePoint (planilha .xlsx)

## üìÇ Estrutura do Projeto- **C√°lculo:** Microsoft Graph Excel API (sess√£o tempor√°ria)

- **SELIC:** API Banco Central SGS

```

selicmvpfinal/### Componentes

‚îÇ```

‚îú‚îÄ‚îÄ üìÅ src/                      # C√≥digo fonte‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

‚îÇ   ‚îú‚îÄ‚îÄ main.py                  # API FastAPI‚îÇ   Browser   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Backend    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Microsoft Graph ‚îÇ

‚îÇ   ‚îú‚îÄ‚îÄ calculator_service.py   # L√≥gica de c√°lculo‚îÇ  (UI Form)  ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  (API REST)  ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   (Excel API)   ‚îÇ

‚îÇ   ‚îú‚îÄ‚îÄ excel_client.py          # Cliente Excel local‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îÇ   ‚îú‚îÄ‚îÄ config.py                # Configura√ß√µes                            ‚îÇ

‚îÇ   ‚îî‚îÄ‚îÄ models.py                # Modelos de dados                            ‚ñº

‚îÇ                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

‚îú‚îÄ‚îÄ üìÅ static/                   # Frontend (HTML/CSS/JS)                     ‚îÇ  API BACEN   ‚îÇ

‚îÇ   ‚îú‚îÄ‚îÄ index.html                     ‚îÇ  (SGS/SELIC) ‚îÇ

‚îÇ   ‚îú‚îÄ‚îÄ styles.css                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îÇ   ‚îî‚îÄ‚îÄ script.js```

‚îÇ

‚îú‚îÄ‚îÄ üìÅ tests/                    # Testes### Fluxo de Execu√ß√£o

‚îÇ   ‚îú‚îÄ‚îÄ test_api.py```

‚îÇ   ‚îî‚îÄ‚îÄ test_cases.py1. Usu√°rio preenche formul√°rio

‚îÇ2. Backend valida inputs

‚îú‚îÄ‚îÄ üìÅ data/                     # Arquivos Excel3. Abre sess√£o Excel (Microsoft Graph)

‚îÇ   ‚îî‚îÄ‚îÄ timon_01-2025.xlsx4. [OPCIONAL] Atualiza SELIC via API BACEN

‚îÇ5. Escreve inputs nas c√©lulas mapeadas

‚îú‚îÄ‚îÄ üìÅ docs/                     # Documenta√ß√£o6. Executa workbook.application.calculate()

‚îÇ   ‚îú‚îÄ‚îÄ LEIA_ME_PRIMEIRO.md     ‚≠ê COMECE AQUI7. L√™ outputs das c√©lulas mapeadas

‚îÇ   ‚îú‚îÄ‚îÄ QUICKSTART_LOCAL.md8. Fecha sess√£o Excel

‚îÇ   ‚îú‚îÄ‚îÄ ESTRUTURA.md9. Retorna JSON com resultados + metadata

‚îÇ   ‚îî‚îÄ‚îÄ ...10. Frontend exibe resultados + bot√£o "Exportar CSV"

‚îÇ```

‚îú‚îÄ‚îÄ üìÅ scripts/                  # Scripts de inicializa√ß√£o

‚îÇ   ‚îú‚îÄ‚îÄ start.bat---

‚îÇ   ‚îú‚îÄ‚îÄ start.ps1

‚îÇ   ‚îî‚îÄ‚îÄ start.sh## üì• MAPEAMENTO DE INPUTS

‚îÇ

‚îú‚îÄ‚îÄ app.py                       # Entrada principal### Aba: **RESUMO**

‚îú‚îÄ‚îÄ requirements.txt             # Depend√™ncias

‚îú‚îÄ‚îÄ .env                         # Configura√ß√£o| Campo | C√©lula | Tipo | Valida√ß√£o | Exemplo |

‚îî‚îÄ‚îÄ README.md                    # Este arquivo|-------|--------|------|-----------|---------|

```| Munic√≠pio | B6 | String | Obrigat√≥rio | "TIMON" |

| Per√≠odo (In√≠cio) | E6 | Data | AAAA-MM-DD | "2000-01-01" |

---| Per√≠odo (Fim) | F6 | Data | AAAA-MM-DD | "2006-12-01" |

| Ajuizamento | B7 | Data | AAAA-MM-DD | "2005-05-01" |

## üìñ Documenta√ß√£o| Cita√ß√£o | B8 | Data | AAAA-MM-DD | "2006-06-01" |

| Honor√°rios (%) | B11 | Decimal | 0.00 - 1.00 | 0.15 (15%) |

| Documento | Descri√ß√£o || Honor√°rios (fixo) | B12 | Decimal | ‚â• 0 | 5000.00 |

|-----------|-----------|| Des√°gio Principal | B13 | Decimal | 0.00 - 1.00 | 0.20 (20%) |

| **[docs/LEIA_ME_PRIMEIRO.md](docs/LEIA_ME_PRIMEIRO.md)** | ‚≠ê **Comece por aqui!** || Des√°gio Honor√°rios | B14 | Decimal | 0.00 - 1.00 | 0.20 (20%) |

| [docs/QUICKSTART_LOCAL.md](docs/QUICKSTART_LOCAL.md) | Guia r√°pido Excel local || Corre√ß√£o at√© | B15 | Data | AAAA-MM-DD | "2025-01-01" |

| [docs/MUDANCAS.md](docs/MUDANCAS.md) | O que mudou? |

| [docs/ESTRUTURA.md](docs/ESTRUTURA.md) | Arquitetura detalhada |### Valida√ß√µes Frontend

| [docs/TODO.md](docs/TODO.md) | Roadmap e pr√≥ximas fases |- Datas: formato AAAA-MM-DD, n√£o pode ser futura

- Percentuais: 0-100% (converter para decimal no backend)

---- Moeda: aceitar R$ 1.234,56 (converter para decimal)

- Per√≠odo Fim > Per√≠odo In√≠cio

## üéØ Funcionalidades- Corre√ß√£o at√© ‚â• Per√≠odo Fim



- ‚úÖ Formul√°rio web para entrada de dados---

- ‚úÖ Integra√ß√£o com Excel local (openpyxl)

- ‚úÖ C√°lculo de 9 cen√°rios trabalhistas## üì§ MAPEAMENTO DE OUTPUTS

- ‚úÖ Exporta√ß√£o de resultados em CSV

- ‚úÖ Interface responsiva### Aba: **RESUMO**

- ‚úÖ Rate limiting (10 req/min)

- ‚úÖ Valida√ß√µes autom√°ticasTodos os outputs est√£o em **3 colunas**:

- **Coluna D:** Principal (ap√≥s des√°gio)

---- **Coluna E:** Honor√°rios %

- **Coluna F:** Total (Principal + Honor√°rios)

## üîß Configura√ß√£o

| Cen√°rio | Linha | D (Principal) | E (Hon. %) | F (Total) |

### 1. Instalar depend√™ncias|---------|-------|---------------|------------|-----------|

| NT7 (IPCA/SELIC/?) | 24 | D24 | E24 | F24 |

```powershell| NT7 (Per√≠odo CNJ) | 29 | D29 | E29 | F29 |

python -m venv venv| NT6 (IPCA/SELIC/?) | 34 | D34 | E34 | F34 |

.\venv\Scripts\Activate.ps1| JASA (IPCA/SELIC/?) | 39 | D39 | E39 | F39 |

pip install -r requirements.txt| NT7 TR | 44 | D44 | E44 | F44 |

```| NT36 TR | 49 | D49 | E49 | F49 |

| NT7 IPCA-E | 54 | D54 | E54 | F54 |

### 2. Configurar .env| NT36 IPCA-E | 64 | D64 | E64 | F64 |

| NT36 IPCA-E + 1% a.m. | 69 | D69 | E69 | F69 |

O arquivo `.env` j√° est√° configurado! Verifique apenas o caminho do Excel:

**Total de c√©lulas a ler:** 27 (9 cen√°rios √ó 3 colunas)

```ini

EXCEL_FILE_PATH=data/timon_01-2025.xlsx### Formato JSON de Resposta

``````json

{

### 3. Executar  "run_id": "uuid-v4",

  "timestamp": "2025-01-15T14:30:00Z",

```powershell  "workbook_version": "etag-ou-hash",

python app.py  "inputs": { /* echo dos inputs */ },

# OU  "outputs": {

.\scripts\start.bat    "nt7_ipca_selic": {

```      "principal": 123456.78,

      "honorarios": 18518.52,

---      "total": 141975.30

    },

## üß™ Testar    "nt7_periodo_cnj": { /* ... */ },

    // ... demais cen√°rios

### Teste Manual  },

1. Acesse http://localhost:8000  "selic_context": {

2. Preencha o formul√°rio    "updated": false,

3. Clique em "Calcular"    "message": "SELIC n√£o atualizada nesta execu√ß√£o"

4. Veja os 9 cen√°rios  }

}

### Teste Automatizado```

```powershell

python tests/test_api.py---

```

## üìä SELIC DIN√ÇMICA (FASE 2)

---

### ‚ö†Ô∏è IMPORTANTE - Estrutura Existente

## üìä Cen√°rios Calculados

A planilha **J√Å possui** aba **"Tabela de Corre√£o e Juros"** com dados hist√≥ricos.  

A aplica√ß√£o calcula **9 cen√°rios** diferentes:**N√ÉO criar novas abas na FASE 1.**



1. NT7 (IPCA/SELIC/?)### API Banco Central SGS

2. NT7 (Per√≠odo CNJ)

3. NT6 (IPCA/SELIC/?)**Endpoint Base:**

4. JASA (IPCA/SELIC/?)```

5. NT7 TRhttps://api.bcb.gov.br/dados/serie/bcdata.sgs.{codigo}/dados?formato=json&dataInicial=DD/MM/AAAA&dataFinal=DD/MM/AAAA

6. NT36 TR```

7. NT7 IPCA-E

8. NT36 IPCA-E**S√©ries Candidatas:**

9. NT36 IPCA-E + 1% a.m.- **11:** SELIC di√°ria (over)

- **432:** Meta SELIC (% a.a.)

---- **4390:** SELIC acumulada no m√™s

- **4189:** SELIC acumulada no m√™s (anualizada base 252)

## üèóÔ∏è Arquitetura

**Exemplo de Resposta:**

``````json

Browser (Formul√°rio)[

       ‚Üì  {"data": "01/01/2024", "valor": "11.75"},

FastAPI Backend (src/main.py)  {"data": "01/02/2024", "valor": "11.25"}

       ‚Üì]

Calculator Service (src/calculator_service.py)```

       ‚Üì

Excel Client (src/excel_client.py)### Estrat√©gia de Implementa√ß√£o

       ‚Üì

Arquivo Excel Local (data/)#### FASE 1 - MVP SEM SELIC (Recomendado)

       ‚Üì- ‚úÖ Usar dados de SELIC j√° presentes na planilha

Resultados (JSON + CSV)- ‚úÖ N√ÉO modificar estrutura de abas

```- ‚úÖ Focar em: inputs ‚Üí c√°lculo ‚Üí outputs



---#### FASE 2 - SELIC Din√¢mica

1. **Investiga√ß√£o (1 semana):**

## üì¶ Tecnologias   - Abrir aba "Tabela de Corre√£o e Juros"

   - Identificar coluna(s) com SELIC (provavelmente coluna K)

- **Backend:** Python 3.11 + FastAPI   - Mapear faixa de c√©lulas (ex: K10:K350)

- **Frontend:** HTML5 + CSS3 + JavaScript   - Testar atualiza√ß√£o manual de 1 valor

- **Excel:** openpyxl

- **Valida√ß√£o:** Pydantic2. **Implementa√ß√£o:**

   ```python

---   # Pseudoc√≥digo

   def atualizar_selic(session, periodo_inicio, periodo_fim):

## ‚ö†Ô∏è Importante       # 1. Consultar API BACEN

       dados = bacen_api.get_selic(periodo_inicio, periodo_fim)

- **Feche o Excel** antes de usar o sistema       

- **Fa√ßa backup** da planilha original       # 2. Preparar range de c√©lulas

- Sistema funciona para **1 usu√°rio por vez** (ideal para MVP)       range_address = "Tabela de Corre√£o e Juros!K10:K350"

       

---       # 3. Escrever valores

       for linha, valor in enumerate(dados):

## üöÄ Pr√≥ximos Passos           session.range(f"K{10+linha}").update(valor)

       

1. Execute `.\scripts\start.bat`       # 4. Salvar metadados

2. Teste com dados de exemplo       return {

3. Valide outputs com planilha manual           "updated": True,

4. Leia a documenta√ß√£o completa em `docs/`           "count": len(dados),

           "source": "API BACEN SGS s√©rie 432"

---       }

   ```

## üêõ Troubleshooting

### Pol√≠tica de Lacunas

### Erro: "Arquivo Excel n√£o encontrado"

- Verifique se a planilha est√° em `data/`**Modo Estrito (fail-fast):**

- Confira o nome no `.env````python

if competencia_faltando:

### Erro: "Permission denied"    raise ValueError(f"SELIC n√£o dispon√≠vel para {competencia}")

- Feche o arquivo Excel```

- Verifique permiss√µes da pasta

**Modo Permissivo (carry-forward):**

Ver mais em: **[docs/QUICKSTART_LOCAL.md](docs/QUICKSTART_LOCAL.md)**```python

if competencia_faltando:

---    valor = ultima_competencia_disponivel

    warnings.append(f"Usando SELIC de {ultima_data}: {valor}%")

## üìÑ Licen√ßa```



MIT License### Fallbacks



---1. **Override Manual:**

   ```json

## üë§ Autor   {

     "selic_override": {

Desenvolvido conforme especifica√ß√£o do Prompt Mestre v2.0       "2025-01": 10.75  // For√ßa este valor apenas para esta execu√ß√£o

     }

---   }

   ```

## üìû Suporte

2. **Importar CSV:**

- üìñ Documenta√ß√£o: Ver pasta `docs/`   ```csv

- üêõ Issues: GitHub   data,taxa_anual

- üí¨ D√∫vidas: Consultar [docs/QUICKSTART_LOCAL.md](docs/QUICKSTART_LOCAL.md)   2024-01-01,11.75

   2024-02-01,11.25

---   ```



<div align="center">### Aba de Auditoria (FASE 2)



**‚≠ê Se este projeto foi √∫til, deixe uma estrela!**Criar aba **`selic_resolver`** para log:



---| Compet√™ncia | Valor Usado | Fonte | Timestamp |

|-------------|-------------|-------|-----------|

**Vers√£o:** 1.0.0 (Excel Local - MVP)  | 2024-01 | 11.75 | API BACEN | 2025-01-15 14:30 |

**Status:** ‚úÖ Pronto para usar  | 2024-02 | 11.25 | API BACEN | 2025-01-15 14:30 |

**√öltima Atualiza√ß√£o:** 01/10/2025| 2025-01 | 10.75 | Override | 2025-01-15 14:30 |



</div>---


## üîå MICROSOFT GRAPH API

### Setup
1. Registrar app no Azure AD
2. Permiss√µes necess√°rias: `Files.ReadWrite`, `Sites.ReadWrite.All`
3. Obter token OAuth2

### Endpoints Principais

```javascript
// 1. Criar sess√£o de trabalho
POST /me/drive/items/{item-id}/workbook/createSession
{
  "persistChanges": false  // Sess√£o tempor√°ria
}

// 2. Escrever inputs
PATCH /me/drive/items/{item-id}/workbook/worksheets/RESUMO/range(address='B6')
{
  "values": [["TIMON"]]
}

// 3. Executar c√°lculo
POST /me/drive/items/{item-id}/workbook/application/calculate
{
  "calculationType": "Full"
}

// 4. Ler outputs
GET /me/drive/items/{item-id}/workbook/worksheets/RESUMO/range(address='D24:F69')

// 5. Fechar sess√£o
DELETE /me/drive/items/{item-id}/workbook/closeSession
```

### Timeout
- Sess√£o expira em **7 minutos** sem atividade
- Implementar retry se sess√£o expirar
- Timeout m√°ximo de execu√ß√£o: **60 segundos**

---

## üíæ PERSIST√äNCIA (M√≠nima)

### Salvar por Execu√ß√£o
```json
{
  "run_id": "uuid",
  "timestamp": "ISO 8601",
  "workbook_version": "etag-ou-sha256",
  "inputs": { /* objeto JSON */ },
  "outputs": { /* objeto JSON */ },
  "selic_context": {
    "updated": true/false,
    "source": "API BACEN / CSV / Override",
    "competencias": [
      {"data": "2024-01", "valor": 11.75, "fonte": "API"}
    ]
  },
  "execution_time_ms": 8234
}
```

### Storage
- **FASE 1:** SQLite local ou arquivos JSON
- **FASE 2+:** PostgreSQL ou MongoDB

---

## üé® INTERFACE (UI)

### P√°gina √önica (SPA)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üßÆ Calculadora Trabalhista                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üìù Dados do Processo                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Munic√≠pio:        [____________]    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ Per√≠odo In√≠cio:   [__/__/____]      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ Per√≠odo Fim:      [__/__/____]      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ Ajuizamento:      [__/__/____]      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ Cita√ß√£o:          [__/__/____]      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ Honor√°rios (%):   [____]%           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ Honor√°rios (R$):  R$ [__________]   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ Des√°gio Principal: [____]%          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ Des√°gio Honor√°rios: [____]%         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ Corre√ß√£o at√©:     [__/__/____]      ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [üîÑ SELIC: Usar dados atuais ‚òê]           ‚îÇ
‚îÇ  [‚öôÔ∏è Calcular]                              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üìä Resultados (ap√≥s c√°lculo)               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ NT7 (IPCA/SELIC/?):                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Principal: R$ 123.456,78          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Honor√°rios: R$ 18.518,52          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Total: R$ 141.975,30              ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ NT7 (Per√≠odo CNJ):                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Principal: R$ 98.765,43           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ...                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [üì• Exportar CSV]  [üîó Copiar Link]       ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  ‚ÑπÔ∏è Run ID: abc-123 | 15/01/2025 14:30     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Elementos Principais
- ‚úÖ Formul√°rio com valida√ß√£o em tempo real
- ‚úÖ Loading spinner durante c√°lculo (5-30s)
- ‚úÖ Exibi√ß√£o clara dos 9 cen√°rios
- ‚úÖ Bot√£o "Exportar CSV" (gera arquivo local)
- ‚úÖ Mensagem de SELIC usada (se FASE 2)
- ‚úÖ Responsivo (mobile-friendly)

---

## üì§ EXPORTA√á√ÉO CSV

### Formato
```csv
Cen√°rio,Principal,Honor√°rios,Total
NT7 (IPCA/SELIC/?),123456.78,18518.52,141975.30
NT7 (Per√≠odo CNJ),98765.43,14814.81,113580.24
NT6 (IPCA/SELIC/?),110000.00,16500.00,126500.00
JASA (IPCA/SELIC/?),105000.00,15750.00,120750.00
NT7 TR,95000.00,14250.00,109250.00
NT36 TR,92000.00,13800.00,105800.00
NT7 IPCA-E,115000.00,17250.00,132250.00
NT36 IPCA-E,112000.00,16800.00,128800.00
NT36 IPCA-E + 1% a.m.,118000.00,17700.00,135700.00

Inputs:
Munic√≠pio,TIMON
Per√≠odo,2000-01-01 a 2006-12-01
Ajuizamento,2005-05-01
Cita√ß√£o,2006-06-01
Honor√°rios,%,0.15
Honor√°rios,Fixo,5000.00
Des√°gio,Principal,0.20
Des√°gio,Honor√°rios,0.20
Corre√ß√£o at√©,2025-01-01

Metadata:
Run ID,abc-123-def
Timestamp,2025-01-15T14:30:00Z
Workbook Version,v1.2.3
```

---

## ‚úÖ CRIT√âRIOS DE ACEITE

### FASE 1 - MVP B√°sico
- [ ] Backend conecta ao Microsoft Graph e abre/fecha sess√£o
- [ ] Escreve 10 inputs nas c√©lulas corretas (B6, E6, F6, B7, B8, B11-B15)
- [ ] Executa `calculate()` com sucesso
- [ ] L√™ 27 outputs (D/E/F nas linhas 24,29,34,39,44,49,54,64,69)
- [ ] UI exibe resultados formatados (moeda brasileira)
- [ ] Exporta√ß√£o CSV funciona e cont√©m todos os dados
- [ ] **3 casos de teste com outputs id√™nticos √† planilha manual** (diferen√ßa < 0.01%)

### FASE 2 - SELIC Din√¢mica (Opcional)
- [ ] Identifica coluna SELIC na aba "Tabela de Corre√£o e Juros"
- [ ] Consulta API BACEN com sucesso (s√©ries 11/432/4390/4189)
- [ ] Atualiza c√©lulas de SELIC sem quebrar f√≥rmulas
- [ ] Modo Estrito bloqueia se faltar compet√™ncia
- [ ] Modo Permissivo usa carry-forward e alerta usu√°rio
- [ ] Fallback CSV funciona
- [ ] Override manual funciona
- [ ] Aba `selic_resolver` registra auditoria
- [ ] Caso de teste com SELIC recente (2024/2025) passa

---

## üß™ CASOS DE TESTE

### Caso 1: Timon Real (Valida√ß√£o)
```json
{
  "inputs": {
    "municipio": "TIMON",
    "periodo_inicio": "2000-01-01",
    "periodo_fim": "2006-12-01",
    "ajuizamento": "2005-05-01",
    "citacao": "2006-06-01",
    "honorarios_perc": 0.0,
    "honorarios_fixo": 0.0,
    "desagio_principal": 0.2,
    "desagio_honorarios": 0.2,
    "correcao_ate": "2025-01-01"
  }
}
```
**Objetivo:** Valores devem bater 100% com planilha manual.

### Caso 2: Honor√°rios Percentual
```json
{
  "inputs": {
    "municipio": "SAO LUIS",
    "periodo_inicio": "2010-01-01",
    "periodo_fim": "2015-12-01",
    "ajuizamento": "2014-03-01",
    "citacao": "2015-06-01",
    "honorarios_perc": 0.15,
    "honorarios_fixo": 0.0,
    "desagio_principal": 0.1,
    "desagio_honorarios": 0.05,
    "correcao_ate": "2024-12-01"
  }
}
```
**Objetivo:** Testar c√°lculo de honor√°rios percentuais.

### Caso 3: SELIC Recente (FASE 2)
```json
{
  "inputs": {
    "municipio": "FORTALEZA",
    "periodo_inicio": "2023-01-01",
    "periodo_fim": "2024-12-01",
    "ajuizamento": "2024-06-01",
    "citacao": "2024-09-01",
    "honorarios_perc": 0.2,
    "honorarios_fixo": 0.0,
    "desagio_principal": 0.0,
    "desagio_honorarios": 0.0,
    "correcao_ate": "2025-01-01"
  },
  "selic_atualizar": true
}
```
**Objetivo:** Garantir que SELIC 2024/2025 seja atualizada via API BACEN.

---

## üìä OBSERVABILIDADE

### Logs Obrigat√≥rios
```python
logger.info(f"[{run_id}] Iniciando execu√ß√£o")
logger.info(f"[{run_id}] Inputs validados: {inputs}")
logger.info(f"[{run_id}] Abrindo sess√£o Excel (workbook_id: {workbook_id})")
logger.info(f"[{run_id}] Escrevendo inputs nas c√©lulas B6-B15")
logger.info(f"[{run_id}] Executando calculate() - aguarde...")
logger.info(f"[{run_id}] C√°lculo conclu√≠do em {calc_time}ms")
logger.info(f"[{run_id}] Lendo outputs D24:F69")
logger.info(f"[{run_id}] Fechando sess√£o Excel")
logger.info(f"[{run_id}] Execu√ß√£o conclu√≠da em {total_time}ms")
```

### M√©tricas (FASE 2+)
- Tempo m√©dio de execu√ß√£o
- Taxa de sucesso/erro
- Chamadas API BACEN (count, lat√™ncia)
- Sess√µes Excel (abertas, fechadas, expiradas)

---

## üö® TRATAMENTO DE ERROS

### Erros Comuns
1. **Sess√£o Excel expirada:**
   ```python
   if error.code == "SessionExpired":
       retry_with_new_session()
   ```

2. **C√©lula n√£o encontrada:**
   ```python
   if error.code == "ItemNotFound":
       raise ValueError(f"C√©lula {address} n√£o existe na planilha")
   ```

3. **API BACEN indispon√≠vel:**
   ```python
   if bacen_api.timeout():
       logger.warning("API BACEN indispon√≠vel, usando dados locais")
       use_fallback_csv()
   ```

4. **C√°lculo muito lento (>60s):**
   ```python
   if execution_time > 60:
       raise TimeoutError("C√°lculo excedeu 60 segundos")
   ```

---

## üîí SEGURAN√áA (M√≠nima)

- ‚úÖ Validar todos os inputs (tipo, range, formato)
- ‚úÖ Sanitizar strings antes de escrever no Excel
- ‚úÖ Rate limiting: 10 execu√ß√µes/minuto por IP
- ‚úÖ Timeout: 60s por execu√ß√£o
- ‚úÖ N√£o expor token Microsoft Graph no frontend
- ‚úÖ HTTPS obrigat√≥rio em produ√ß√£o

---

## üì¶ ENTREG√ÅVEIS

### FASE 1
1. ‚úÖ C√≥digo fonte (backend + frontend)
2. ‚úÖ README com instru√ß√µes de setup
3. ‚úÖ 3 casos de teste documentados com outputs esperados
4. ‚úÖ Scripts de deploy (Docker/Heroku/Vercel)

### FASE 2
5. ‚úÖ Documenta√ß√£o de integra√ß√£o API BACEN
6. ‚úÖ Scripts de fallback CSV
7. ‚úÖ Aba `selic_resolver` na planilha

---

## üéì REFER√äNCIAS

### APIs
- Microsoft Graph Excel: https://learn.microsoft.com/graph/api/resources/excel
- BACEN SGS: https://www3.bcb.gov.br/sgspub/

### Bibliotecas
**Python:**
```bash
pip install fastapi uvicorn requests openpyxl pandas python-dotenv
```

**Node.js:**
```bash
npm install express @microsoft/microsoft-graph-client axios dotenv
```

---

## ‚úÖ CHECKLIST FINAL

### Antes de Come√ßar
- [ ] Ler este documento completo
- [ ] Confirmar acesso √† planilha no OneDrive/SharePoint
- [ ] Registrar app no Azure AD (Microsoft Graph)
- [ ] Escolher stack (Python ou Node.js)
- [ ] Clonar reposit√≥rio e configurar ambiente

### Durante Desenvolvimento
- [ ] Implementar backend (inputs ‚Üí c√°lculo ‚Üí outputs)
- [ ] Implementar frontend (formul√°rio + resultados)
- [ ] Adicionar valida√ß√µes
- [ ] Implementar exporta√ß√£o CSV
- [ ] Executar 3 casos de teste
- [ ] Documentar setup no README

### Antes de Entregar
- [ ] Outputs id√™nticos √† planilha manual (3 casos)
- [ ] UI responsiva em mobile
- [ ] Logs funcionando
- [ ] Deploy em ambiente de teste
- [ ] Documenta√ß√£o completa

---

**FIM DO PROMPT MESTRE**

**Vers√£o:** 2.0  
**√öltima Atualiza√ß√£o:** 01/10/2025  
**Validado com:** `timon_01-2025.xlsx`
